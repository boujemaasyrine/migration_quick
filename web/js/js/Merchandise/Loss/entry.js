function calculateSum(e){var t=$($(e).closest("tr")[0]),a=$($($(e).closest("tr").children("td")[2]).find("input")[0]),n=0;a.val(n),$.each(t.find(".qty-input"),function(){n=""!=$(this).val()?parseFloat($(this).val())+parseFloat(n):$(this).val()+parseFloat(n),a.val(floatToString(n))})}function validateEntries(){var e=!0;return $(".splitted_input").each(function(){null==$(this).val().match(regex)&&""!=$(this).val()&&null!=$(this).val()&&"_inventory_initial_qty_"!=$(this).val()&&($(this).addClass("shadow-danger"),e=!1)}),e}function getLineByLoss(e){loader.block(),ajaxCall({url:Routing.generate("get_line_by_loss",{modelId:e}),dataType:"json"},function(e){"undefined"!=typeof e.data&&0!=e.data.length?($("#table_loss").html(e.data[0]),initProductAutocomplete(),initLossEntryTable(),loadLossSheetLines(e.data.lines),$("#table_loss").fadeIn()):Notif.alert(Translator.trans("loss.entry.js.no_loss_sheet"),500,3e3),loader.unblock()})}function loadLossSheetLines(e){e.sort(function(e,t){return e.order<t.order?-1:e.order>t.order?1:0}),e.forEach(function(e){var t=e.refProduct,a=e.idProduct,n=e.productName,l=e.productUsageQty,o=e.productInventoryQty,r=$("#loss_list_article"),s=parseInt(r.attr("data-count"));r.attr("data-count",s+1);var i=r.data("prototype").replace(/_line_number_/g,s).replace(/_product_id_/,a).replace(/_first_entry_cnt_/g,"").replace(/_second_entry_cnt_/g,"").replace(/_third_entry_cnt_/g,"").replace(/_product_reference_/g,t).replace(/_product_name_/g,n);if("articles_loss_model"===lossSheetType)i=i.replace(/_qty_modal_btn_/g,'<span class="text-muted input-group-addon setUnitsInDetails btn_open_qtys_modal" style=" padding-right: 2px; padding-left: 2px; float: left; color:#000; background: #fff;"> <i class="glyphicon glyphicon-option-vertical"></i></span>').replace(/_data_block_/g,'data-inventory-qty="'+o+'" data-usage-qty="'+l+'" data-inventory-unit-label="'+e.labelUnitInventory+'" data-usage-unit-label="'+e.labelUnitUsage+'" data-expedition-unit-label="'+e.labelUnitExped+'" data-product-name="'+n+'"').replace(/_inventory_label_total_/g,'<span class="text-muted input-group-addon" style="margin-right: 5px; padding-right: 2px; padding-left: 2px;">'+Translator.trans(e.labelUnitInventory)+"</span>").replace(/_inventory_label_splited_/g,'<span class="text-muted input-group-addon" style="margin-right: 5px; padding-right: 2px; padding-left: 2px;">'+Translator.trans(e.labelUnitInventory)+"</span>");else{var d=e.soldingCanalsId;i=i.replace(/_qty_modal_btn_/g,"").replace(/_data_block_/g,"").replace(/_inventory_label_total_/g,"").replace(/_inventory_label_splited_/g,"").replace(/__name__/g,s).replace(/_solding_canals_id_/g,d);var c=e.isTransformedProduct;c===!1&&(i=$(i),$(i.find(".solding_canals")).html(""))}lossEntryTable.row.add($(i)).draw()})}function initProductAutocomplete(){var e=$("#productId"),t=$("#productName"),a=$("#productReference");"articles_loss_model"===lossSheetType?(a.autocomplete({autoFill:!0,source:function(e,t){var a=e.term;return termKey(a)in productCodeCache?void t(productCodeCache[termKey(a)]):void ajaxCall({url:Routing.generate("find_active_products",{code:a,selectedType:$("#sheet_model_linesType").val(),filterSecondary:"true"}),method:GET},function(e){void 0==e.errors&&(productCodeCache[termKey(a)]=$.map(e.data[0],function(e){var t={id:e.id,name:e.name,label:e.externalId,value:e.externalId,externalId:e.externalId};return"articles_loss_model"===lossSheetType&&(t=$.extend(t,{inventoryQty:e.inventoryQty,usageQty:e.usageQty,labelUnitInventory:e.labelUnitInventory,labelUnitUsage:e.labelUnitUsage,labelUnitExped:e.labelUnitExped})),t}),t(productCodeCache[termKey(a)]))},null,null,!0)},select:function(a,n){t.val(n.item.name),e.val(n.item.id),selectedArticle=n.item}}),t.autocomplete({autoFill:!0,source:function(e,t){var a=e.term;return termKey(a)in productNameCache?void t(productNameCache[termKey(a)]):void ajaxCall({url:Routing.generate("find_active_products",{term:a,selectedType:$("#sheet_model_linesType").val(),filterSecondary:"true"}),method:GET},function(e){void 0==e.errors&&(productNameCache[termKey(a)]=$.map(e.data[0],function(e){var t={id:e.id,name:e.name,label:e.externalId+"- "+e.name,value:e.name,externalId:e.externalId};return"articles_loss_model"===lossSheetType&&(t=$.extend(t,{inventoryQty:e.inventoryQty,usageQty:e.usageQty,labelUnitInventory:e.labelUnitInventory,labelUnitUsage:e.labelUnitUsage,labelUnitExped:e.labelUnitExped})),t}),t(productNameCache[termKey(a)]))},null,null,!0)},select:function(t,n){e.val(n.item.id),a.val(n.item.externalId),selectedArticle=n.item}})):(a.autocomplete({autoFill:!0,source:function(e,t){var a=e.term;return termKey(a)in productCodeCache?void t(productCodeCache[termKey(a)]):void ajaxCall({url:Routing.generate("find_active_products",{code:a,selectedType:$("#sheet_model_linesType").val(),filterSecondary:"true"}),method:GET},function(e){void 0==e.errors&&(productCodeCache[termKey(a)]=$.map(e.data[0],function(e){return{id:e.id,name:e.name,label:e.codePlu+"- "+e.name,value:e.codePlu,codePlu:e.codePlu,isTransformedProduct:e.isTransformedProduct,soldingCanalsId:e.soldingCanalsId}}),t(productCodeCache[termKey(a)]))},null,null,!0)},select:function(a,n){e.val(n.item.id),t.val(n.item.name),selectedArticle=n.item}}),t.autocomplete({autoFill:!0,source:function(e,t){var a=e.term;return termKey(a)in productCodeCache?void t(productCodeCache[termKey(a)]):void ajaxCall({url:Routing.generate("find_active_products",{term:a,selectedType:$("#sheet_model_linesType").val(),filterSecondary:"true"}),method:GET},function(e){void 0==e.errors&&(productCodeCache[termKey(a)]=$.map(e.data[0],function(e){return{id:e.id,name:e.name,label:e.codePlu+"- "+e.name,value:e.name,codePlu:e.codePlu,isTransformedProduct:e.isTransformedProduct,soldingCanalsId:e.soldingCanalsId}}),t(productCodeCache[termKey(a)]))},null,null,!0)},select:function(t,n){e.val(n.item.id),a.val(n.item.codePlu),selectedArticle=n.item}}))}function termKey(e){return e+"_"+$("#sheet_model_linesType").val()}function initLossEntryTable(){lossEntryTable=initSimpleDataTable("#loss-entry-table",{lengthChange:!0,searching:!0,processing:!1,ordering:!1,paginate:!0})}var loss=[],productNameCache={},productCodeCache={},lossEntryTable=null,previous="",regex=/^[0-9]+([,\.]{1}[0-9]+)?$/;$(function(){function e(){fiscalDatepicker=initDatePicker(".previous-date",{disable:[!0,{from:new Date(from),to:new Date(to)}]}),loader.unblock(),$(".previous-date").on("change",function(e){loader.block(),$("form#previous_date").submit()})}yesterdayLoss&&e()}),$(document).on("focus","#loss_sheet_model",function(){previous=$(this).val()}).on("change","#loss_sheet_model",function(){event.preventDefault(),""!=$(this).val()&&(""!==previous?bootbox.confirm({title:Translator.trans("loss.confirm.data_will_be_erased"),message:Translator.trans("popup.do_you_confirm_this_action"),closeButton:!1,buttons:{cancel:{label:Translator.trans("btn.cancel"),className:"btn-default margin-right-left"},confirm:{label:Translator.trans("loss.confirm.continue"),className:"btn-primary margin-right-left"}},callback:function(e){e&&getLineByLoss($("#loss_sheet_model").val())}}):getLineByLoss($("#loss_sheet_model").val()))}),$(document).on("keyup",".splitted_input",function(){null==$(this).val().match(regex)&&""!=$(this).val()&&null!=$(this).val()?($(this).addClass("shadow-danger"),$(".paginate_button").addClass("disabled"),$("#loss-entry-table_length select").attr("disabled",!0)):($(this).removeClass("shadow-danger"),validateEntries()?($(".paginate_button").removeClass("disabled"),$("#loss-entry-table_length select").attr("disabled",!1)):($(".paginate_button").addClass("disabled"),$("#loss-entry-table_length select").attr("disabled",!0)))}),$(document).on("click","#validate-loss-product",function(){if(loader.block(),validateEntries()){lossEntryTable.destroy(),$("#loss_sheet_status").val("set"),sheet=$("#id-sheet").text();var e=null;yesterdayLoss?(e="previous_day_loss",$("#lossSetForm").attr("action",Routing.generate(e,{lossSheet:$("#loss_sheet_id").val(),type:lossSheetType,date:previousDate}))):(e="loss_entry",$("#lossSetForm").attr("action",Routing.generate(e,{lossSheet:$("#loss_sheet_id").val(),type:lossSheetType}))),$("#loss_sheet_type").removeAttr("disabled"),$("#loss_sheet_entryDate").removeAttr("disabled"),$("#lossSetForm").submit()}else loader.unblock(),bootbox.confirm({title:Translator.trans("loss.errors.title"),message:Translator.trans("loss.errors.message"),closeButton:!1,buttons:{cancel:{label:Translator.trans("btn.cancel"),className:"hidden"},confirm:{label:Translator.trans("loss.errors.validate"),className:"btn-primary margin-right-left"}},callback:function(){}})}),$(document).on("click","#btnAddNewLossSheetLine",function(){var e=$("#productId").val(),t=$("#productReference").val(),a=$("#productName").val();if(""!=e&&""!=a){var n=$("#loss_list_article"),l=parseInt(n.attr("data-count"));n.attr("data-count",l+1);var o=n.data("prototype").replace(/_line_number_/g,l).replace(/_product_reference_/g,t).replace(/_product_id_/g,e).replace(/_first_entry_cnt_/g,"").replace(/_second_entry_cnt_/g,"").replace(/_third_entry_cnt_/g,"").replace(/_product_name_/g,a);if("articles_loss_model"===lossSheetType){var r=selectedArticle.inventoryQty,s=selectedArticle.usageQty,i=selectedArticle.labelUnitInventory,d=selectedArticle.labelUnitUsage,c=selectedArticle.labelUnitExped;o=o.replace(/_qty_modal_btn_/g,'<span class="text-muted input-group-addon setUnitsInDetails btn_open_qtys_modal" style="float: left; color:#000; background: #fff; padding-right: 2px; padding-left: 2px;"> <i class="glyphicon glyphicon-option-vertical"></i></span>').replace(/_data_block_/g,'data-inventory-qty="'+r+'" data-usage-qty="'+s+'" data-inventory-unit-label="'+i+'" data-usage-unit-label="'+d+'" data-expedition-unit-label="'+c+NaN+a+'"').replace(/_inventory_label_total_/g,'<span class="text-muted input-group-addon" style="margin-right: 5px; padding-right: 2px; padding-left: 2px;">'+Translator.trans(i)+"</span>").replace(/_inventory_label_splited_/g,'<span class="text-muted input-group-addon" style="margin-right: 5px; padding-right: 2px; padding-left: 2px;">'+Translator.trans(i)+"</span>")}else{var u=selectedArticle.soldingCanalsId;o=o.replace(/_qty_modal_btn_/g,"").replace(/_data_block_/g,"").replace(/_inventory_label_total_/g,"").replace(/_inventory_label_splited_/g,"").replace(/__name__/g,l).replace(/_solding_canals_id_/g,u);var p=selectedArticle.isTransformedProduct;if(p===!1)o=$(o),$(o.find(".solding_canals")).html("");else{o=$(o);var _=JSON.parse($(o.find(".solding_canals")[0]).attr("data-allowed-solding-canals"))[0];$(o.find(".solding_canals")[0]).val(_)}}lossEntryTable.row.add($(o)).draw(),$("#productId").val(""),$("#productName").val(""),$("#productReference").val("")}else highlightInput("#productName","shadow-danger")});var selectedArticle=null,keyUpNamespace="next_cell";$(document).on("focus",".qty-input",function(){var e=$(this);shortcutController.add(KEY_ENTER,null,null,function(){var t=lossEntryTable.cell($(e).closest("td")[0]).index().column,a=$($($($(e).closest("tr").next("tr")[0]).children("td")[t]).find("input")[0]);a.focus(),a.select()},keyUpNamespace);$(e).focusout(function(){$(document).unbind("keyup."+keyUpNamespace)})}),$(function(){function e(){if($("#qtysForm").valid()){var e=parseFloat($("#qtysForm #totalQty").text()),t=$($(a.closest("div")).find("input")[0]);t.val(floatToString(e)),calculateSum(a),$("#default-modal-box").modal("hide")}}function t(){var e=0;$("#qtysForm input").each(function(t,a){$(a).val()&&!isNaN($(a).val())&&(e+="usageQtyInput"==$($(a)[0]).attr("id")?parseFloat($(a).val())/parseFloat(l):"expeditionQtyInput"==$($(a)[0]).attr("id")?parseFloat($(a).val())*parseFloat(n):parseFloat($(a).val()))}),$("#qtysForm #totalQty").html(floatToString(e))}initProductAutocomplete(),initLossEntryTable(),$(document).on("focus",".solding_canal_input",function(){var e=($(this),JSON.parse($(this).closest(".solding_canals").attr("data-allowed-solding-canals"))),t=$(this).find("option");t.each(function(t,a){$.inArray(parseInt($(a).val()),e)===-1?$(a).attr("disabled","disabled"):$(a).removeAttr("disabled")})}),$(document).on("keyup",".qty-input",function(){calculateSum(this)}),$(document).on("click",".btnRemoveSheetLossLine",function(){var e=$(this).closest("tr")[0],t=lossEntryTable.row(e);t.remove(),e.remove()}),$(window).keydown(function(e){if(e.keyCode==KEY_ENTER)return e.preventDefault(),!1});var a=null,n=null,l=null;$(document).on("click",".setUnitsInDetails",function(e){var o=$($(this).closest("div").find("input")[0]),r=$(this).closest("tr"),s=$(r).attr("data-inventory-unit-label"),i=$(r).attr("data-usage-unit-label"),d=$(r).attr("data-expedition-unit-label"),c=$(r).attr("data-product-name");n=$(r).attr("data-inventory-qty"),l=$(r).attr("data-usage-qty");var u=$("#formContainer").html();u=u.replace(/_inventory_initial_qty_/g,floatToString(parseFloat(o.val()))).replace(/_form_id_/g,"qtysForm").replace(/_unit_usage_/g,Translator.trans(i)).replace(/_unit_inventory_/g,Translator.trans(s)).replace(/_unit_exped_/g,Translator.trans(d)),a=$(this),showDefaultModal(Translator.trans("loss.notification.entry_loosed_qty",{productName:c}),u,$("#qtysFormFooter").html(),"98%"),$("#default-modal-box #usageQtyInput").first().focus(),$(".error").html(""),$("#qtysForm").validate({rules:{usageInput:{regex:regex},inventoryInput:{regex:regex},expedInput:{regex:regex}},messages:{},errorPlacement:function(e,t){var a=$(t).attr("data-error");a?$(a).append(e):e.insertAfter(t)}}),t()}),$(document).on("click","#saveQtys",function(){e()}),$(document).on("keyup","#expeditionQtyInput",function(t){t.keyCode==KEY_ENTER&&e()}),$(document).on("keyup","#inventoryQtyInput",function(t){t.keyCode==KEY_ENTER&&e()}),$(document).on("keyup","#usageQtyInput",function(t){t.keyCode==KEY_ENTER&&e()}),$(document).on("keyup","#qtysForm input",function(e){t()})});