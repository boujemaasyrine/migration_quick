function getSelectedProductsId(){var t=[];return $.each($(".cmd-line .product input"),function(e,n){t.push(parseInt($(n).val()))}),t}function initAutoCompleteForNewLine(){$("#code-product").autocomplete({source:function(t,e){var n=[];$.each(products,function(e,a){$.inArray(a.id,getSelectedProductsId())<0&&a.code.toString().toUpperCase().indexOf(t.term.toUpperCase())>=0&&n.push({value:a.code,label:a.code+" ("+a.name+")",product:a})}),sortTabByProp(n,"value",t.term),e(n)},select:function(t,e){$("#name-product").val(e.item.product.name),$("#new-line-unit-price").html(floatToString(e.item.product.unit_price)),$("#new-line-unit-label").html(Translator.trans(e.item.product.unitInv)),$("#new-line-unit-use-label").html(Translator.trans(e.item.product.unitUse)),$("#new-line-unit-exp-label").html(Translator.trans(e.item.product.unitExp)),$("#stock-qty").val(e.item.product.stock),$("#qty-cmd").focus()},autoFocus:!0}),$("#name-product").autocomplete({source:function(t,e){var n=[];$.each(products,function(e,a){$.inArray(a.id,getSelectedProductsId())<0&&a.name.toUpperCase().indexOf(t.term.toUpperCase())>=0&&n.push({value:a.name,label:a.name+" ("+a.code+")",product:a})}),sortTabByProp(n,"value",t.term),e(n)},select:function(t,e){$("#code-product").val(e.item.product.code),$("#new-line-unit-price").html(floatToString(e.item.product.unit_price)),$("#stock-qty").val(e.item.product.stock),$("#new-line-unit-label").html(Translator.trans(e.item.product.unitInv)),$("#new-line-unit-use-label").html(Translator.trans(e.item.product.unitUse)),$("#new-line-unit-exp-label").html(Translator.trans(e.item.product.unitExp)),$("#qty-cmd").focus()},autoFocus:!0})}function getProductBy(t,e){var n;for(n in products){var a=products[n];if(a.hasOwnProperty(t)&&a[t].toString()==e.toString())return a}return null}function verifyInput(t){return t.removeClass("shadow-danger"),""!=t.val().trim()&&(isNaN(t.val().trim())||0==Number.isInteger(parseFloat(t.val().trim()))||parseInt(t.val().trim())<0)?(t.addClass("shadow-danger"),t.focus(),$(".btn-validate").attr("disabled",!0),!1):(""==t.val().trim()&&t.val(0),$(".btn-validate").attr("disabled",!1),!0)}function addNewLine(t){var e=$("#code-product"),n=$("#qty-cmd"),a=$("#qty-cmd-use"),r=$("#qty-cmd-exp"),i=$("#new-line-unit-price"),o=$("#stock-qty"),l=$("#name-product");if(e.removeClass("shadow-danger"),n.removeClass("shadow-danger"),"undefined"!=typeof t&&""==e.val().trim())return!0;if(""==e.val().trim())return e.addClass("shadow-danger"),e.focus(),!1;verifyInput(n),verifyInput(a),verifyInput(r);var u=getProductBy("code",e.val().trim());if(null==u)return e.addClass("shadow-danger"),!1;if($.inArray(u.id,getSelectedProductsId())>=0)return e.addClass("shadow-danger"),!1;var s=$("#products-table tbody"),d=s.attr("data-prototype"),c=parseInt(s.attr("count"));s.attr("count",c+1);var p=parseInt(a.val())/(u.use_ratio*u.inv_ratio)*u.unit_price,_=parseInt(n.val())/u.inv_ratio*u.unit_price,v=parseInt(r.val())*u.unit_price,f=p+_+v;f=Math.round(100*f)/100;var m=parseInt(a.val())/u.use_ratio;m+=parseInt(n.val()),m+=parseInt(r.val())*u.inv_ratio,m=Math.round(100*m)/100;var y=d.replace(/__name__/g,c).replace(/__ref_product__/g,u.code).replace(/__name_product__/g,u.name).replace(/__unit__/g,Translator.trans(u.unitInv)).replace(/__unit_use__/g,Translator.trans(u.unitUse)).replace(/__unit_exp__/g,Translator.trans(u.unitExp)).replace(/__unit_price__/g,floatToString(u.unit_price)).replace(/__total_qty__/g,floatToString(m)).replace(/__val__/g,floatToString(f));$("#new-line").before(y),$("#transfer_in_lines_"+c+"_product").val(u.id),$("#transfer_in_lines_"+c+"_qty").val(n.val()),$("#transfer_in_lines_"+c+"_qtyUse").val(a.val()),$("#transfer_in_lines_"+c+"_qtyExp").val(r.val()),$("#transfer_out_lines_"+c+"_product").val(u.id),$("#transfer_out_lines_"+c+"_qty").val(n.val()),$("#transfer_out_lines_"+c+"_qtyUse").val(a.val()),$("#transfer_out_lines_"+c+"_qtyExp").val(r.val()),e.val(""),n.val(""),a.val(""),r.val(""),i.html(""),o.val(""),l.val(""),$("#new-line-unit-label, #new-line-unit-use-label, #new-line-unit-exp-label, #new-total-line ").html(""),e.focus(),updateTransfertValorization()}function updateTransfertValorization(){var t=$(".line-valorization"),e=0;$.each(t,function(t,n){e+=parseFloat($(n).html())}),e=Math.round(100*e)/100,$("#transfer_in_valorization").val(floatToString(e)),$("#transfer_out_valorization").val(floatToString(e)),$("#span-transfer-val").html(floatToString(e))}function updateLineVal(t){var e=$(t).find(".qty-line"),n=$(t).find(".qty-line-use"),a=$(t).find(".qty-line-exp");if(!(verifyInput(e)&&verifyInput(n)&&verifyInput(a)))return!1;var r=$(t).find(".product input").val(),i=getProductBy("id",parseInt(r)),o=$(t).find(".line-valorization"),l=$(t).find(".total"),u=parseInt(n.val())/i.use_ratio;u+=parseInt(e.val()),u+=parseInt(a.val())*i.inv_ratio,u=Math.round(100*u)/100;var s=parseInt(n.val())/(i.use_ratio*i.inv_ratio)*i.unit_price,d=parseInt(e.val())/i.inv_ratio*i.unit_price,c=parseInt(a.val())*i.unit_price,p=s+d+c;p=Math.round(100*p)/100,o.html(floatToString(p)),l.html(floatToString(u))}function updadeNewTotal(){var t=$("#qty-cmd"),e=$("#qty-cmd-use"),n=$("#qty-cmd-exp"),a=$("#code-product"),r=getProductBy("code",a.val().trim());verifyInput(t),verifyInput(e),verifyInput(n);var i=parseInt(e.val())/r.use_ratio;i+=parseInt(t.val()),i+=parseInt(n.val())*r.inv_ratio,i=Math.round(100*i)/100,$("#new-total-line").html(floatToString(i)+" "+Translator.trans(r.unitInv))}var products=[];$(document).on("change",".qty-line, .qty-line-use, .qty-line-exp",function(){var t=$(this).parentsUntil("tbody","tr");updateLineVal(t),updateTransfertValorization()}),$(document).on("click",".remove-line",function(){$(this).parentsUntil("tbody","tr").remove(),updateTransfertValorization()}),$(document).on("submit","form",function(){addNewLine(!0);return loader.show(),!0}),$(document).on("change","#qty-cmd, #qty-cmd-use, #qty-cmd-exp",function(){updadeNewTotal()}),$(function(){loader.show(),ajaxCall({url:Routing.generate("get_product_by_supplier",{filterSecondary:"true"}),dataType:"json"},function(t){products=t.data,loader.hide()}),initAutoCompleteForNewLine(),$("#new-line-btn").on("click",function(){addNewLine()}),shortcutController.addCtrlShift(107,function(){addNewLine()}),$("#transfer_in_restaurant").selectize(),$("#transfer_out_restaurant").selectize(),$("#qty-cmd, #qty-cmd-use, #qty-cmd-exp").keypress(function(t){13==t.which&&addNewLine()}),$("form[name=transfer_in], form[name=transfer_out]").keypress(function(t){if(13==t.which)return t.stopPropagation(),!1});var t=moment();if($("#transfer_in_dateTransfer").length>0){var e=$("#transfer_in_dateTransfer").pickadate("picker");e.set("max",[t.year(),t.month(),t.date()])}if($("#transfer_out_dateTransfer").length>0){var n=$("#transfer_out_dateTransfer").pickadate("picker");n.set("max",[t.year(),t.month(),t.date()])}});