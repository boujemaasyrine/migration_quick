function getSelectedProductsId(){var t=[];return $.each($(".cmd-line .product input"),function(e,n){t.push(parseInt($(n).val()))}),t}function refreshProducts(){ajaxCall({url:Routing.generate("get_product_by_supplier",{supplier:supplierId,filterSecondary:"true"}),dataType:"json"},function(t){"undefined"!=typeof t.data&&t.data.length>0&&(products=t.data)})}function initAutoCompleteForNewLine(){$("#code-product").autocomplete({source:function(t,e){var n=[];$.each(products,function(e,r){$.inArray(r.id,getSelectedProductsId())<0&&r.code.toString().toUpperCase().indexOf(t.term.toUpperCase())>=0&&n.push({value:r.code,label:r.code+" ("+r.name+")",product:r})}),sortTabByProp(n,"value",t.term),e(n)},select:function(t,e){var n=floatToString(parseFloat(e.item.product.unit_price));$("#name-product").val(e.item.product.name),$("#new-line-unit-label").html(Translator.trans(e.item.product.unitInv)),$("#new-line-unit-use-label").html(Translator.trans(e.item.product.unitUse)),$("#new-line-unit-exp-label").html(Translator.trans(e.item.product.unitExp)),$("#new-line-unit-price").html(n),$("#qty-cmd-exp").focus()},autoFocus:!0}),$("#name-product").autocomplete({source:function(t,e){var n=[];$.each(products,function(e,r){$.inArray(r.id,getSelectedProductsId())<0&&r.name.toUpperCase().indexOf(t.term.toUpperCase())>=0&&n.push({value:r.name,label:r.name+" ("+r.code+")",product:r})}),sortTabByProp(n,"value",t.term),e(n)},select:function(t,e){var n=floatToString(parseFloat(e.item.product.unit_price));$("#code-product").val(e.item.product.code),$("#new-line-unit-price").html(n),$("#new-line-unit-label").html(Translator.trans(e.item.product.unitInv)),$("#new-line-unit-use-label").html(Translator.trans(e.item.product.unitUse)),$("#new-line-unit-exp-label").html(Translator.trans(e.item.product.unitExp)),$("#qty-cmd-exp").focus()},autoFocus:!0})}function getProductBy(t,e){var n;for(n in products){var r=products[n];if(r.hasOwnProperty(t)&&r[t].toString()==e.toString())return r}return null}function addReturnLine(t){var e=$("#code-product"),n=$("#qty-cmd"),r=$("#qty-cmd-use"),a=$("#qty-cmd-exp"),i=$("#new-line-unit-price"),o=$("#stock-qty"),u=$("#name-product");if(e.removeClass("shadow-danger"),n.removeClass("shadow-danger"),"undefined"!=typeof t&&""==e.val().trim())return!0;if(""==e.val().trim())return e.addClass("shadow-danger"),e.focus(),!1;verifyInput(n),verifyInput(r),verifyInput(a);var l=getProductBy("code",$("#code-product").val().trim());if(null==l)return e.addClass("shadow-danger"),!1;if($.inArray(l.id,getSelectedProductsId())>=0)return e.addClass("shadow-danger"),!1;var d=parseInt($("#regularization-lines tbody").attr("count"));$("#regularization-lines tbody").attr("count",d+1);var p=parseInt(r.val())/(l.use_ratio*l.inv_ratio)*l.unit_price,c=parseInt(n.val())/l.inv_ratio*l.unit_price,s=parseInt(a.val())*l.unit_price,v=p+c+s;v=Math.round(100*v)/100;var m=parseInt(r.val())/l.use_ratio;m+=parseInt(n.val()),m+=parseInt(a.val())*l.inv_ratio,m=Math.round(100*m)/100;var _=$("#regularization-lines tbody").attr("data-prototype"),f=_.replace(/__name__/g,d).replace(/__ref_product__/g,l.code).replace(/__name_product__/g,l.name).replace(/__unit__/g,Translator.trans(l.unitInv)).replace(/__unit_use__/g,Translator.trans(l.unitUse)).replace(/__unit_exp__/g,Translator.trans(l.unitExp)).replace(/__unit_price__/g,floatToString(l.unit_price)).replace(/__total_qty__/g,floatToString(m)).replace(/__val__/g,floatToString(v));$("#new-line").before(f),$("#return_lines_"+d+"_product").val(l.id),$("#return_lines_"+d+"_qty").val(n.val()),$("#return_lines_"+d+"_qtyUse").val(r.val()),$("#return_lines_"+d+"_qtyExp").val(a.val()),e.val(""),n.val(""),r.val(""),a.val(""),i.html(""),o.val(""),u.val(""),$("#new-line-unit-label, #new-line-unit-use-label, #new-line-unit-exp-label, #new-total-line ").html(""),e.focus(),updateReturnVal()}function updateReturnVal(){var t=0,e=$(".line-valorization");$.each(e,function(e,n){t+=parseFloat($(n).html())}),$("#regularization-val").html(floatToString(Math.round(100*t)/100))}function verifyInput(t){return t.removeClass("shadow-danger"),""!=t.val().trim()&&(isNaN(t.val().trim())||0==Number.isInteger(parseFloat(t.val().trim()))||parseInt(t.val().trim())<0)?(t.addClass("shadow-danger"),t.focus(),!1):(""==t.val().trim()&&t.val(0),!0)}function updadeNewTotal(){var t=$("#qty-cmd"),e=$("#qty-cmd-use"),n=$("#qty-cmd-exp"),r=$("#code-product"),a=getProductBy("code",r.val().trim());verifyInput(t),verifyInput(e),verifyInput(n);var i=parseInt(e.val())/a.use_ratio;i+=parseInt(t.val()),i+=parseInt(n.val())*a.inv_ratio,i=Math.round(100*i)/100,$("#new-total-line").html(floatToString(i)+" "+Translator.trans(a.unitInv))}function updateLineVal(t){var e=$(t).find(".qty-line"),n=$(t).find(".qty-line-use"),r=$(t).find(".qty-line-exp");if(!(verifyInput(e)&&verifyInput(n)&&verifyInput(r)))return!1;var a=$(t).find(".product input").val(),i=getProductBy("id",parseInt(a)),o=$(t).find(".line-valorization"),u=$(t).find(".total"),l=parseInt(n.val())/i.use_ratio;l+=parseInt(e.val()),l+=parseInt(r.val())*i.inv_ratio,l=Math.round(100*l)/100;var d=parseInt(n.val())/(i.use_ratio*i.inv_ratio)*i.unit_price,p=parseInt(e.val())/i.inv_ratio*i.unit_price,c=parseInt(r.val())*i.unit_price,s=d+p+c;s=Math.round(100*s)/100,o.html(floatToString(s)),u.html(floatToString(l))}var products=[],supplierId=null;$(function(){supplierId=$("#return_supplier").val(),null!=supplierId&&refreshProducts(),initAutoCompleteForNewLine(),updateReturnVal(),$("#qty-cmd, #qty-cmd-use, #qty-cmd-exp").keypress(function(t){13==t.which&&addReturnLine()}),$("form[name=return]").keypress(function(t){if(13==t.which)return t.stopPropagation(),!1}),$("#return_supplier").selectize()}),$(document).on("change",".qty-line, .qty-line-use, .qty-line-exp",function(){var t=$(this).parentsUntil("tbody","tr");updateLineVal(t),updateReturnVal()}),$(document).on("change","#return_supplier",function(){supplierId=$(this).val(),refreshProducts()}),$(document).on("click","#new-line-btn",function(){addReturnLine()}),$(document).on("click",".remove-line",function(){$(this).parentsUntil("tbody","tr").remove()}),$(document).on("change","#qty-cmd, #qty-cmd-use, #qty-cmd-exp",function(){updadeNewTotal()}),$(document).on("submit","form",function(){var t=addReturnLine(!0);if(t)return loader.show(),!0});