$(function(){function e(){var e=moment($("#inventory_sheet_fiscalDate").first().attr("data-from-date"),"YYYY/MM/DD");_=initDatePicker("#inventory_sheet_fiscalDate",{disable:[!0,{from:new Date(e.format("YYYY/MM/DD")),to:new Date((new Date).setDate((new Date).getDate()-1))}],onOpen:function(){$("#inventory_sheet_fiscalDate_root .picker__today").remove()}})}function t(){c=initSimpleDataTable("#inventorySheetFormTable",{paging:!0,searching:!0,ordering:!0,aaSorting:[],processing:!1}),r(),initDatePicker(),e()}function n(){loader.block(),ajaxCall({method:"POST",url:Routing.generate("load_inventory_entry"),data:$("#inventory_sheet_form").serialize()},function(e){void 0===e.errors&&(i.html(e.data[0]),i.fadeIn(),t(),d.ajax.reload(),a(e.data.lines),$("#table_container").fadeIn())},null,function(){loader.unblock()})}function a(e){e.sort(function(e,t){return e.order<t.order?-1:e.order>t.order?1:0}),e.forEach(function(e){var t=e.refProduct,n=e.idProduct,a=e.productName,r=(e.productUsageQty,e.productInventoryQty,$("#containerLines")),o=parseInt(r.attr("data-count"));r.attr("data-count",o+1);var l=r.data("prototype").replace(/_line_number_/g,o).replace(/_id_product_/g,n).replace(/_usage_product_cnt_/g,"").replace(/_inventory_product_cnt_/g,"").replace(/_exped_product_cnt_/g,"").replace(/_inventory_product_usage_unit_label_/g,Translator.trans(e.labelUnitUsage)).replace(/_inventory_product_inventory_unit_label_/g,Translator.trans(e.labelUnitInventory)).replace(/_inventory_product_exped_unit_label_/g,Translator.trans(e.labelUnitExped)).replace(/_label_product_/g,a);l=void 0!==t?l.replace(/_ref_product_/g,t):l.replace(/_ref_product_/g,""),c.row.add($(l)).draw()})}function r(){var e=$("#productId"),t=$("#productName"),n=$("#productReference");n.autocomplete({autoFill:!0,source:function(e,t){var n=e.term;return o(n)in s?void t(s[o(n)]):void ajaxCall({url:Routing.generate("find_active_products",{code:n,selectedType:"article",filterSecondary:"true"}),method:GET},function(e){void 0==e.errors&&(s[o(n)]=$.map(e.data[0],function(e){return{id:e.id,name:e.name,label:e.externalId,value:e.externalId,externalId:e.externalId,labelUnitUsage:e.labelUnitUsage,labelUnitInventory:e.labelUnitInventory,labelUnitExped:e.labelUnitExped}}),t(s[o(n)]))},null,null,!0)},select:function(n,a){t.val(a.item.name),e.val(a.item.id),p=a.item}}),t.autocomplete({autoFill:!0,source:function(e,t){var n=e.term;return o(n)in u?void t(u[o(n)]):void ajaxCall({url:Routing.generate("find_active_products",{term:n,selectedType:"article",filterSecondary:"true"}),method:GET},function(e){void 0==e.errors&&(u[o(n)]=$.map(e.data[0],function(e){return{id:e.id,name:e.name,label:e.name,externalId:e.externalId,labelUnitUsage:e.labelUnitUsage,labelUnitInventory:e.labelUnitInventory,labelUnitExped:e.labelUnitExped}}),t(u[o(n)]))},null,null,!0)},select:function(t,a){e.val(a.item.id),n.val(a.item.externalId),p=a.item}})}function o(e){return e}function l(){var e=!0,t=/^[0-9]+([,\.]{1}[0-9]+)?$/;return $(".splitted_input").each(function(){null==$(this).val().match(t)&&""!=$(this).val()&&null!=$(this).val()&&"_inventory_initial_qty_"!=$(this).val()&&($(this).addClass("shadow-danger"),e=!1)}),e}var i=$("#inventory_block"),d=null,c=null,s={},u={},_=null;""===$("#inventory_sheet_sheetModel").val()&&$("#btnCreateInventorySheetFromModel").prop("disabled",!0),t(),d=initSimpleDataTable("#inventory-table",{searching:!0,processing:!0,serverSide:!0,order:[[1,"desc"]],ajax:{url:Routing.generate("inventory_list"),type:"GET"},columns:[{data:"id"},{data:"createdAt.timestamp",render:function(e){return moment.unix(e).format("DD/MM/YYYY HH:mm:ss")}},{data:"fiscalDate.timestamp",render:function(e){return moment.unix(e).format("DD/MM/YYYY")}},{data:"sheetModelLabel"},{data:null,orderable:!1,render:function(e){var t=(moment(),moment.unix(e.createdAt.timestamp),$("#inventory-table").attr("data-template"));return t=t.replace(/_id_/g,e.id)},targets:0}],drawCallback:function(){$('[data-toggle="tooltip"]').tooltip()}}),$(document).on("click","#btnAddNewInventoryEntry",function(){var e=$(this);loader.block(e),ajaxCall({method:"GET",url:Routing.generate("inventory_entry")},function(e){void 0===e.errors&&(i.html(e.data[0]),i.fadeIn(),t())},null,function(){loader.unblock(e)})}),$(document).on("click","#btnAddNewLine",function(e){var t=$("#productReference").val(),n=$("#productId").val(),a=$("#productName").val(),r=$("#productUsageQty").val(),o=$("#productInventoryQty").val(),l=$("#productExpedQty").val();if(""!=n&&""!=a){var i=$("#containerLines"),d=parseInt(i.attr("data-count"));i.attr("data-count",d+1);var s=i.data("prototype").replace(/_line_number_/g,d).replace(/_id_product_/g,n).replace(/_usage_product_cnt_/g,r).replace(/_inventory_product_cnt_/g,o).replace(/_exped_product_cnt_/g,l).replace(/_label_product_/g,a);s=null!=p?s.replace(/_inventory_product_usage_unit_label_/g,Translator.trans(p.labelUnitUsage)).replace(/_inventory_product_inventory_unit_label_/g,Translator.trans(p.labelUnitInventory)).replace(/_inventory_product_exped_unit_label_/g,Translator.trans(p.labelUnitExped)):s.replace(/_inventory_product_usage_unit_label_/g,"").replace(/_inventory_product_inventory_unit_label_/g,"").replace(/_inventory_product_exped_unit_label_/g,""),s=void 0!==t?s.replace(/_ref_product_/g,t):s.replace(/_ref_product_/g,""),c.row.add($(s)).draw(),$("#productId").val(""),$("#productName").val(""),$("#productReference").val("")}else highlightInput("#productName","shadow-danger")}),$(document).on("click",".btnRemoveLine",function(){c.row($(this).parents("tr")).remove().draw()}),$(document).on("click","#validateInventory",function(){l()?(c.destroy(),$("#inventory_sheet_sheetModel").removeAttr("disabled"),loader.block(),$("#inventory_sheet_form").submit()):(loader.unblock(),bootbox.confirm({title:Translator.trans("loss.errors.title"),message:Translator.trans("loss.errors.message"),closeButton:!1,buttons:{cancel:{label:Translator.trans("btn.cancel"),className:"hidden"},confirm:{label:Translator.trans("loss.errors.validate"),className:"btn-primary margin-right-left"}},callback:function(){}}))});var v="";$(document).on("change","#inventory_sheet_sheetModel",function(){""!==$("#inventory_sheet_sheetModel").val()&&""===v&&$("#btnCreateInventorySheetFromModel").prop("disabled",!1)}),$(document).on("click","#btnCreateInventorySheetFromModel",function(e){""===v?n():bootbox.confirm({title:Translator.trans("loss.confirm.data_will_be_erased"),message:Translator.trans("popup.do_you_confirm_this_action"),closeButton:!1,buttons:{cancel:{label:Translator.trans("btn.cancel"),className:"btn-default margin-right-left"},confirm:{label:Translator.trans("loss.confirm.continue"),className:"btn-primary margin-right-left"}},callback:function(e){e&&n()}})}),$(document).on("click",".btnEntryInventory",function(e){var n=($(this),$(this).attr("data-id")),a={validated:!1};""!==$("#inventory_sheet_id").val()&&(a.inventorySheet=$("#inventory_sheet_id").val()),loader.block(),ajaxCall({method:"GET",url:Routing.generate("inventory_entry",{inventorySheet:n})},function(e){void 0===e.errors&&(i.html(e.data[0]),i.fadeIn(),t())},null,function(){loader.unblock()})}),$(document).on("click",".btnDetailsInventory",function(e){var n=$(this),a=$(this).attr("data-id");loader.block(n),ajaxCall({method:"GET",url:Routing.generate("inventory_sheet_details",{inventorySheet:a})},function(e){void 0===e.errors&&(showDefaultModal(Translator.trans("inventory.title.consult"),e.data[0],"",1e3,null),t())},null,function(){loader.unblock(n)})});var p=null;$(document).on("keyup",".qty-input",function(){var e=/^[0-9]+([,\.]{1}[0-9]+)?$/;if(null==$(this).val().match(e)&&""!=$(this).val()&&null!=$(this).val())$(this).addClass("shadow-danger"),$(".paginate_button").addClass("disabled"),$("#inventorySheetFormTable_length select").attr("disabled",!0);else if($(this).removeClass("shadow-danger"),l()){$(".paginate_button").removeClass("disabled"),$("#inventorySheetFormTable_length select").attr("disabled",!1);var t=$($(this).closest("tr")),n=$(t.find(".real_stock").first()),a=parseFloat(n.attr("data-usage-qty")),r=parseFloat(n.attr("data-inventory-qty")),o=parseFloat(n.attr("data-real-stock")),i=n.attr("data-product-inventory-unit-label"),d=parseFloat($(t.find(".expedCnt").first()).val()),c=parseFloat($(t.find(".inventoryCnt").first()).val()),s=parseFloat($(t.find(".usageCnt").first()).val()),u=o;u+=c+d*r+s/a-o,n.text(u.toFixed(2)+" "+i)}else $(".paginate_button").addClass("disabled"),$("#inventorySheetFormTable_length select").attr("disabled",!0)}),$(window).keydown(function(e){if(e.keyCode==KEY_ENTER)return e.preventDefault(),!1});var m="next_cell";$(document).on("focus",".qty-input",function(){var e=this;shortcutController.add(KEY_ENTER,null,null,function(){var t=c.cell($(e).closest("td")[0]).index().column,n=$($($($(e).closest("tr").next("tr")[0]).children("td")[t]).find("input")[0]);n.focus(),n.select()},m);$(e).focusout(function(){$(document).unbind("keyup."+m)})}),$(document).on("focus","#inventory_sheet_sheetModel",function(){v=this.value}).on("change","#inventory_sheet_sheetModel",function(){event.preventDefault(),""!=$(this).val()?$("#btnCreateInventorySheetFromModel").removeAttr("disabled"):$("#btnCreateInventorySheetFromModel").attr("disabled","disabled")})});