function getOrderList(e,t,r,i){void 0!=t&&1==t&&loader.show(),ajaxCall({url:Routing.generate("pending_list"),method:"POST",data:{criteria:{status:e}},dataType:"json"},function(e){orders=orders.concat(e.data),void 0!=i&&i(),void 0!=r&&1==r&&loader.hide()})}function getOrderBy(e,t){var r;for(r in orders){var i=orders[r];if(i.hasOwnProperty(e)&&i[e].toString()==t.toString())return i}return null}function initDeliveryForm(e,t){return null==e?void $("#delivery_supplier option").removeProp("selected"):($("#delivery_supplier option[value='"+e.supplier+"']").prop("selected","selected"),$("#order_delivery_date").html(e.dateDelivery),setInputValue("#orderDate",e.dateOrder),void 0!=t&&1!=t||getOrderLines(e),updateDeliveryValorisation(),void getProductsBySupplier(e.supplier_id))}function getOrderLines(e){loader.show(),$("#delivery-entry-table tbody").html(""),ajaxCall({url:Routing.generate("order_lines",{order:e.id}),dataType:"json"},function(e){var t=0;$.each(e.data,function(e,r){addDeliveryLine(r,t),t++}),$("#delivery-entry-table tbody").attr("count",t),updateDeliveryValorisation(),loader.hide()})}function addDeliveryLine(e,t){var r=$("#delivery-entry-table tbody").attr("data-prototype"),i=floatToString(Math.round(parseFloat(e.price)*parseInt(e.qty)*100)/100),o=r.replace(/__name__/g,t).replace(/__ref_product__/g,e.code).replace(/__name_product__/g,e.article).replace(/__unit__/g,Translator.trans(e.unit_exped)).replace(/__ordered_qty__/g,e.qty).replace(/__unit_price__/g,floatToString(e.price)).replace(/__line_val__/,i);$("#delivery-entry-table tbody").append(o),$("#delivery_lines_"+t+"_product_id").val(e.code),$("#delivery_lines_"+t+"_qty").val(e.qty),$("#delivery_lines_"+t+"_valorization").val(floatToString(Math.round(parseFloat(e.price)*parseInt(e.qty)*100)/100)),$("#delivery_lines_"+t+"_new option").removeProp("selected"),$("#delivery_lines_"+t+"_new option[value=0]").prop("selected","selected"),$(".cmd-line ").last().find(".remove-line").remove(),updateDeliveryValorisation()}function updateDeliveryValorisation(){var e=0,t=$(".delivery-line-valorisation");$.each(t,function(t,r){e+=parseFloat($(r).val())});var r=floatToString(Math.round(100*e)/100);$("#delivery_valorization").val(r),$("#delivery-valorization-span").html(r)}function getProductsBySupplier(e){products=[],ajaxCall({url:Routing.generate("get_product_by_supplier",{supplier:e}),dataType:"json"},function(e){"undefined"!=typeof e.data&&e.data.length>0&&(products=e.data)})}function getSelectedProductsId(){var e=[];return $.each($(".cmd-line .hidden input"),function(t,r){e.push(parseInt($(r).val()))}),e}function initAutoCompleteForNewLine(){$("#code-product").autocomplete({source:function(e,t){var r=[];$.each(products,function(t,i){$.inArray(parseInt(i.code),getSelectedProductsId())<0&&i.code.toString().toUpperCase().indexOf(e.term.toUpperCase())>=0&&r.push({value:i.code,label:i.code+" ("+i.name+")",product:i})}),sortTabByProp(r,"value",e.term),t(r)},select:function(e,t){$("#name-product").val(t.item.product.name),$("#new-line-unit-price").html(floatToString(t.item.product.unit_price)),$("#unit-new-line").html(Translator.trans(t.item.product.unitExp)),$("#qty-product").focus()},autoFocus:!0}),$("#name-product").autocomplete({source:function(e,t){var r=[];$.each(products,function(t,i){$.inArray(parseInt(i.code),getSelectedProductsId())<0&&i.name.toUpperCase().indexOf(e.term.toUpperCase())>0&&r.push({value:i.name,label:i.name+" ("+i.code+")",product:i})}),sortTabByProp(r,"value",e.term),t(r)},select:function(e,t){$("#code-product").val(t.item.product.code),$("#new-line-unit-price").html(floatToString(t.item.product.unit_price)),$("#unit-new-line").html(Translator.trans(t.item.product.unitExp)),$("#qty-product").focus()},autoFocus:!0})}function getProductBy(e,t){var r;for(r in products){var i=products[r];if(i.hasOwnProperty(e)&&i[e].toString()==t.toString())return i}return null}function addNewDeliveryLine(e){if($("#code-product").removeClass("shadow-danger"),$("#qty-product").removeClass("shadow-danger"),"undefined"!=typeof e&&""==$("#code-product").val().trim())return!0;if(""==$("#code-product").val().trim())return $("#code-product").focus(),$("#code-product").addClass("shadow-danger"),!1;if(""==$("#qty-product").val().trim()||isNaN($("#qty-product").val().trim())||0==Number.isInteger(parseFloat($("#qty-product").val().trim()))||parseInt($("#qty-product").val().trim())<=0)return $("#qty-product").focus(),$("#qty-product").addClass("shadow-danger"),!1;var t=getProductBy("code",$("#code-product").val().trim());if(null==t)return $("#code-product").focus(),$("#code-product").addClass("shadow-danger"),!1;var r=parseInt($("#delivery-entry-table tbody").attr("count"));$("#delivery-entry-table tbody").attr("count",r+1);var i=$("#qty-product").val(),o=floatToString(Math.round(parseFloat(t.unit_price)*parseInt(i)*100)/100),n=$("#delivery-entry-table tbody").attr("data-prototype"),a=n.replace(/__name__/g,r).replace(/__ref_product__/g,t.code).replace(/__name_product__/g,t.name).replace(/__unit__/g,Translator.trans(t.unitExp)).replace(/__ordered_qty__/g,"0").replace(/__unit_price__/g,floatToString(t.unit_price)).replace(/__line_val__/,o);return $("#delivery-entry-table tbody").append(a),$("#delivery_lines_"+r+"_product_id").val(t.code),$("#delivery_lines_"+r+"_qty").val(i),$("#delivery_lines_"+r+"_observation option[value='not_ordred']").attr("selected","selected"),$("#delivery_lines_"+r+"_valorization").val(o),$("#code-product").val(""),$("#qty-product").val(""),$("#name-product").val(""),$("#new-line-unit-price").html(""),$("#code-product").focus(),updateDeliveryValorisation(),!0}function init(){if(inited1&&inited2&&inited3){clearTimeout(tout);var e=$("#delivery_order").val();order=getOrderBy("id",e),initDeliveryForm(order,!1),loader.hide()}else tout=window.setTimeout(function(){return init()},500)}function clearIndexes(){for(var e=$(".cmd-line"),t=/delivery_lines_[0-9]*/,r=/delivery\[lines]\[[0-9]*/,i=0;i<e.length;i++)for(var o=$(e[i]).find("input, select"),n=0;n<o.length;n++){var a=$(o[n]),d=a.attr("id"),l=a.attr("name"),c=d.replace(t,"delivery_lines_"+i),u=l.replace(r,"delivery[lines]["+i);a.attr("id",c),a.attr("name",u)}}var orders=[],order=null,numOrder=null,products=[],tout=null,inited1=!1,inited2=!1,inited3=!1;$(document).on("change",".delivery-line-qty",function(e){parseInt($(this).val())<0&&(e.stopPropagation(),$(this).val(0))}),$(document).on("change","#delivery_supplier",function(){if(""==$(this).val())$("#delivery_order option").removeClass("hidden");else{$("#delivery_order option").addClass("hidden");var e=$(this);$.each(orders,function(t,r){r.supplier==e.val()&&$("#delivery_order option[value='"+r.id+"']").removeClass("hidden")})}$("#delivery_order option[value='']").removeClass("hidden"),$("#delivery_order option[value='']").prop("selected","selected"),$(".cmd-line").remove(),$("#delivery-valorization-span").html("0.00")}),$(document).on("change","#delivery_order",function(){$("#delivery_order option").removeClass("hidden"),$("#delivery_supplier option").removeProp("selected"),$("#delivery_supplier option[value='']").prop("selected","selected"),$(".cmd-line").remove(),$("#delivery-valorization-span").html("0.00");var e=$("#delivery_order").val();order=getOrderBy("id",e),initDeliveryForm(order)}),$(document).on("change",".delivery-line-qty",function(){var e=$(this),t=$(this).parentsUntil("tbody","tr").find(".delivery-line-valorisation"),r=parseFloat($(this).parentsUntil("tbody","tr").find(".unit-price").html()),i=Math.round(parseFloat(e.val())*r*100)/100;t.val(floatToString(i)),$(this).parentsUntil("tbody","tr").find(".val-delivery-line").html(floatToString(i));var o=parseFloat($(this).parentsUntil("tbody","tr").find(".order-line-qty").html());parseFloat(e.val())!=o?$(this).parentsUntil("tbody","tr").addClass("order-delivery-mismatch"):$(this).parentsUntil("tbody","tr").removeClass("order-delivery-mismatch"),updateDeliveryValorisation()}),$(document).on("change",".delivery-line-valorisation",function(){updateDeliveryValorisation()}),$(document).on("click",".remove-line",function(){$(this).parentsUntil("tbody","tr").remove()}),$(document).on("click","#print-bl-btn",function(){var e=$("form[name=delivery]");e.attr("action",Routing.generate("delivery_entry")+"?download=1"),e.submit()}),$("form[name='delivery']").on("submit",function(){var e=addNewDeliveryLine(!0);if(e)return loader.show(),!0}),$("form[name=delivery]").on("submit",function(){return clearIndexes()}),$(document).ready(function(){var e=moment(),t=e.add(1,"d"),r=$("#delivery_date").pickadate("picker");r.set("disable",[{from:[t.year(),t.month(),t.date()],to:3e3}]),getOrderList("sended",!0,!1,function(){inited1=!0}),getOrderList("rejected",!1,!1,function(){inited2=!0}),getOrderList("modified",!1,!1,function(){inited3=!0}),initAutoCompleteForNewLine(),shortcutController.addCtrlShift(107,function(){addNewDeliveryLine()}),updateDeliveryValorisation(),$("#qty-product").keypress(function(e){13==e.which&&addNewDeliveryLine()}),$("form[name=delivery]").keypress(function(e){if(13==e.which)return e.stopPropagation(),!1}),init()});